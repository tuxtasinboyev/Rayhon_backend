generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPERADMIN
  ADMIN
  WAITER
  CHEF
  CASHIER
}

enum UserStatus {
  ACTIVE
  BLOCKED
}

enum TableStatus {
  EMPTY
  BUSY
  RESERVED
}

enum OrderStatus {
  NEW
  COOKING
  READY
  SERVED
  CLOSED
  CANCELLED
}

enum PaymentType {
  CASH
  CARD
}

enum ProductType {
  SINGLE
  SET
}

enum PaymentStatus {
  PAID
  PENDING
  REFUNDED
  PARTIAL
}

model Restaurant {
  id      Int     @id @default(autoincrement())
  name    String  @unique
  phone   String?
  address String?
  status  Boolean @default(true)

  users      User[]
  branches   Branch[]
  categories Category[]
  products   Product[]
  orders     Order[]

  createdAt DateTime @default(now())
  updateAt  DateTime @default(now()) @updatedAt
}

model Branch {
  id      Int     @id @default(autoincrement())
  name    String  @unique
  address String?
  status  Boolean @default(true)

  restaurantId Int
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  users  User[]
  tables Table[]
  orders Order[]

  createdAt DateTime @default(now())
  updateAt  DateTime @default(now()) @updatedAt

  @@unique([restaurantId, name])
}

model User {
  id       Int        @id @default(autoincrement())
  fullname String
  phone    String     @unique
  role     UserRole
  password String
  status   UserStatus @default(ACTIVE)

  branchId Int
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  orders Order[] @relation("WaiterOrders")

  createdAt    DateTime    @default(now())
  restaurant   Restaurant? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  restaurantId Int?

  updateAt DateTime @default(now()) @updatedAt
}

model Table {
  id       Int         @id @default(autoincrement())
  number   Int
  capacity Int
  status   TableStatus @default(EMPTY)

  branchId Int
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  orders    Order[]
  createdAt DateTime @default(now())
  updateAt  DateTime @default(now()) @updatedAt

  @@unique([branchId, number])
}

model Category {
  id     Int     @id @default(autoincrement())
  name   String
  status Boolean? @default(true)

  restaurantId Int
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  products  Product[]
  createdAt DateTime  @default(now())
  updateAt  DateTime  @default(now()) @updatedAt

  @@unique([restaurantId, name])
}

model Product {
  id       Int         @id @default(autoincrement())
  name     String
  price    Float
  type     ProductType @default(SINGLE)
  isActive Boolean     @default(true)
  status   Boolean?     @default(true)

  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  restaurantId Int
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  setItems   SetItem[] @relation("SetProducts")
  asSetItems SetItem[] @relation("SetContainer")

  orderItems OrderItem[]
  createdAt  DateTime    @default(now())
  updateAt   DateTime    @default(now()) @updatedAt

  @@unique([restaurantId, name])
}

model SetItem {
  id       Int     @id @default(autoincrement())
  quantity Int
  status   Boolean? @default(true)

  setId Int
  set   Product @relation("SetContainer", fields: [setId], references: [id], onDelete: Cascade)

  productId Int
  product   Product  @relation("SetProducts", fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updateAt  DateTime @default(now()) @updatedAt

  @@unique([setId, productId])
}

model Order {
  id          Int         @id @default(autoincrement())
  status      OrderStatus @default(NEW)
  totalPrice  Float       @default(0)
  guestsCount Int?

  branchId Int
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  tableId Int
  table   Table @relation(fields: [tableId], references: [id], onDelete: Cascade)

  waiterId Int
  waiter   User @relation("WaiterOrders", fields: [waiterId], references: [id], onDelete: Cascade)

  items    OrderItem[]
  payments Payment[]

  openedAt DateTime  @default(now())
  closedAt DateTime?

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  restaurant   Restaurant? @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  restaurantId Int?
  updateAt     DateTime    @default(now()) @updatedAt
}

model OrderItem {
  id       Int     @id @default(autoincrement())
  quantity Int
  price    Float
  note     String?
  status Boolean @default(true)

  orderId   Int
  productId Int

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orderId, productId])
}

model Payment {
  id     Int           @id @default(autoincrement())
  amount Float
  type   PaymentType
  status PaymentStatus
 
  orderId Int
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updateAt  DateTime @default(now()) @updatedAt

  @@unique([orderId, type])
}
